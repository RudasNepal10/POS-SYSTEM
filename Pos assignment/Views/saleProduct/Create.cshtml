@model infrastructurre.DTO.SaleProductDTO;
<!DOCTYPE html>
<html lang="en">

<head>

</head>

<body>
    <div class="AddSales">
    </div><!-- End Page Title -->
    <section class="section">
        <div class="row">

           

            <div class="ibox col-lg-12">

                <div class="ibox-title">
                    <h5>Add Sales</h5>
                </div>

                <div class="card">
                    <div class="card-body">
                        <form method="post" action="Create" enctype="multipart/form-data" class="row g-3" id="salesForm">
                            <div class="row col-md-12">
                                <div class="col-md-4">
                                    <label class="form-label">Product</label>
                                    @Html.DropDownList("product_id", ViewBag.ProductList as SelectList, "-- Select --", new { @Class = "form-control" })
                                    @Html.ValidationMessageFor(a => a.product_id, null, new { @Class = "text-danger" })
                                </div>

                                <div class="col-md-4">
                                    <label for="inputText" class="form-label">Quantity</label>
                                    @Html.TextBoxFor(a => a.quantity, new { placeholder = "0", @Class = "form-control", type = "number", min = "0", step = "1" })
                                    <div class="invalid-feedback">
                                        @Html.ValidationMessageFor(a => a.quantity, null, new { @Class = "text-danger" })
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <button class="btn btn-primary btn-addProduct" type="button" style="margin-top: 25px;">Add</button>
                                </div>

                                <div class="mt-4 col-md-9">
                                    <h1 class="text-center" style="color:red">Item List</h1>

                                    <table id="productTable" class="table">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Quantity</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Table rows will be dynamically added here -->
                                        </tbody>
                                    </table>
                                </div>


                            </div>

                            <div class="row mt-4 col-md-12">

                                <div class="col-md-4">
                                    <label class="form-label">Customer</label>
                                    @Html.DropDownList("customer_Id", ViewBag.CustomerList as SelectList, "-- Select --", new { @Class = "form-control", required = "required" })
                                    @Html.ValidationMessageFor(a => a.customer_Id, null, new { @Class = "text-danger" })
                                </div>


                                <div class="col-md-4">
                                    <label class="form-label">Payment Method</label>
                                    @Html.DropDownList("payment_method_id", ViewBag.PaymentMethodList as SelectList, "-- Select --", new { @Class = "form-control", required = "required" })
                                    @Html.ValidationMessageFor(a => a.payment_method_id, null, new { @Class = "text-danger" })
                                </div>
                            </div>

                            <div class="col-4 mt-4">
                                <button class="btn btn-primary" type="submit">Save form</button>
                            </div>




                        </form>





                    </div>
                </div>
            </div>
        </div>
    </section>

    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

</body>


</html>

@section scripts {
    <script>
        $(document).ready(function () {
            $('.btn-addProduct').on('click', function () {
                var selectedValue = $('#product_id').val();
                var quantity = $('#quantity').val();
                var selectedText = $('#product_id option:selected').text();

                if (selectedValue === '') {
                    $('#productError').text('Please select a product.');
                    return;
                } else {
                    $('#productError').text('');
                }

                // Check if the product already exists in the table
                var exists = false;
                $('#productTable tbody tr').each(function () {
                    var productName = $(this).find('td:first-child').text();
                    if (productName === selectedText) {
                        exists = true;
                        return false; // Exit the loop early
                    }
                });

                if (!exists) {
                    // Append the selected values to the table
                    var newRow = '<tr><td>' + selectedText + '</td><td>' + quantity + '</td><td><input type="hidden" name="productId" value="' + selectedValue + '"><button class="btn btn-danger btn-removeProduct">Remove</button></td></tr>';
                    $('#productTable tbody').append(newRow);

                    // Clear the form fields
                    $('#product_id').val('');
                    $('#quantity').val('');
                } else {
                    alert('Product already exists in the table!');
                }
            });

            // Remove row from table when remove button clicked
            $(document).on('click', '.btn-removeProduct', function () {
                $(this).closest('tr').remove();     
            });

            // Form submission handling
            $('#salesForm').submit(function (e) {
                e.preventDefault(); // Prevent default form submission

                // Serialize the table data
                var salesData = [];
                $('#productTable tbody tr').each(function () {
                    var rowData = {};
                    rowData.product_id = $(this).find('input[name="productId"]').val();
                    rowData.product = $(this).find('td:first-child').text();
                    rowData.quantity = $(this).find('td:nth-child(2)').text();
                    salesData.push(rowData);
                });

                var selectedCustomer = $('#customer_Id option:selected').val();

                var selectedPaymentMethod = $('#payment_method_id option:selected').val();

                var finaldata = {
                    customer_Id: +selectedCustomer,
                    payment_method_id: +selectedPaymentMethod,
                    SalesProduct: salesData
                }

                postReqArr('/saleProduct/Save', finaldata, null, res => {
                    console.log(res,'resfrompost')
                })
            });
        });


        function postReqArr(url, data, constr, arr, fnClear = null, redir = null) {
            $.ajaxSetup({ async: false });
            return $.post(url, data, function (result, status, xhr) {
                var res = JSON.parse(result);
                console.log(res,'response')

            }).done(() => {
            }).fail((xhr, status, message) => {
            });
        }
    </script>

}
